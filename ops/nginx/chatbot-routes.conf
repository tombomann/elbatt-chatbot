# Elbatt Chatbot routes (proxy til 127.0.0.1:8001)

# /embed.js – lastes via <script> på www.elbatt.no
location = /embed.js {
  proxy_http_version 1.1;
  proxy_set_header Host              $host;
  proxy_set_header X-Real-IP         $remote_addr;
  proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_pass http://127.0.0.1:8001/embed.js;

  # CORS for script
  add_header Access-Control-Allow-Origin $elbatt_cors_origin always;
  add_header Vary Origin always;

  # Grei cache
  add_header Cache-Control "public, max-age=600, immutable";
}

# /widget – HTML i <iframe>; la www.elbatt.no ramme inn
location = /widget {
  proxy_http_version 1.1;
  proxy_set_header Host              $host;
  proxy_set_header X-Real-IP         $remote_addr;
  proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_pass http://127.0.0.1:8001/widget;

  # Fjern ev. X-Frame-Options fra upstream og spesifiser frame-ancestors
  proxy_hide_header X-Frame-Options;
  add_header Content-Security-Policy "frame-ancestors https://www.elbatt.no" always;
}

# Statisk klient under /client/
location ^~ /client/ {
  proxy_http_version 1.1;
  proxy_set_header Host              $host;
  proxy_set_header X-Real-IP         $remote_addr;
  proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_pass http://127.0.0.1:8001;

  add_header Access-Control-Allow-Origin $elbatt_cors_origin always;
  add_header Vary Origin always;
}

# API under /api/ (inkl. preflight)
location ^~ /api/ {
  if ($request_method = OPTIONS) {
    add_header Access-Control-Allow-Origin $elbatt_cors_origin always;
    add_header Access-Control-Allow-Methods "GET,POST,OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
    add_header Access-Control-Max-Age 86400 always;
    add_header Vary "Origin, Access-Control-Request-Method, Access-Control-Request-Headers" always;
    return 204;
  }

  proxy_http_version 1.1;
  proxy_set_header Host              $host;
  proxy_set_header X-Real-IP         $remote_addr;
  proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_pass http://127.0.0.1:8001;

  add_header Access-Control-Allow-Origin $elbatt_cors_origin always;
  add_header Vary Origin always;
}
