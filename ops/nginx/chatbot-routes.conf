# Elbatt Chatbot routes -> 127.0.0.1:8001
# Fjerner X-Frame-Options fra upstream og tillater innramming fra www.elbatt.no
# NB: add_header ... always krever at headerne settes på ALLE svar (også feil)
# https://nginx.org/en/docs/http/ngx_http_headers_module.html#add_header

# 1) /embed.js – script tag hos www.elbatt.no
location = /embed.js {
  proxy_http_version 1.1;
  proxy_set_header Host              $host;
  proxy_set_header X-Real-IP         $remote_addr;
  proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_pass http://127.0.0.1:8001/embed.js;

  add_header Access-Control-Allow-Origin $elbatt_cors_origin always;
  add_header Vary Origin always;
}

# 2) /widget – HTML som lastes i <iframe src="https://chatbot.elbatt.no/widget">
location = /widget {
  proxy_http_version 1.1;
  proxy_set_header Host              $host;
  proxy_set_header X-Real-IP         $remote_addr;
  proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_pass http://127.0.0.1:8001/widget;

  # Tillat innramming av widget på www.elbatt.no
  add_header Content-Security-Policy "frame-ancestors https://www.elbatt.no" always;
  # Blank ut X-Frame-Options dersom upstream sender DENY/SAMEORIGIN
  add_header X-Frame-Options "" always;
}

# 3) /client/ – statiske filer fra backend
location ^~ /client/ {
  proxy_http_version 1.1;
  proxy_set_header Host              $host;
  proxy_set_header X-Real-IP         $remote_addr;
  proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_pass http://127.0.0.1:8001;

  add_header Access-Control-Allow-Origin $elbatt_cors_origin always;
  add_header Vary Origin always;
}

# 4) /api/* – proxes til Node/Express
location ^~ /api/ {
  # Preflight
  if ($request_method = OPTIONS) {
    add_header Access-Control-Allow-Origin $elbatt_cors_origin always;
    add_header Access-Control-Allow-Methods "GET,POST,OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
    add_header Access-Control-Max-Age 86400 always;
    add_header Vary "Origin, Access-Control-Request-Method, Access-Control-Request-Headers" always;
    return 204;
  }

  proxy_http_version 1.1;
  proxy_set_header Host              $host;
  proxy_set_header X-Real-IP         $remote_addr;
  proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;

  # WS-støtte: bruk $connection_upgrade mappet i http-kontekst
  proxy_set_header Upgrade    $http_upgrade;
  proxy_set_header Connection $connection_upgrade;

  proxy_pass http://127.0.0.1:8001;

  # CORS på vanlige svar
  add_header Access-Control-Allow-Origin $elbatt_cors_origin always;
  add_header Vary Origin always;
}
