# Elbatt Chatbot routes (proxy til 127.0.0.1:8001)
# Tillat innramming av widget fra www.elbatt.no og fjern ev. X-Frame-Options fra upstream.

# /embed.js – scriptet du inkluderer på www.elbatt.no
location = /embed.js {
  proxy_http_version 1.1;
  proxy_set_header Host              $host;
  proxy_set_header X-Real-IP         $remote_addr;
  proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_pass http://127.0.0.1:8001/embed.js;
  add_header Access-Control-Allow-Origin $elbatt_cors_origin always;
  add_header Vary Origin always;
}

# /widget – selve HTMLen som lastes i iframe
location = /widget {
  proxy_http_version 1.1;
  proxy_set_header Host              $host;
  proxy_set_header X-Real-IP         $remote_addr;
  proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_pass http://127.0.0.1:8001/widget;

  # Viktig: la www.elbatt.no få lov til å ramme inn denne siden
  add_header Content-Security-Policy "frame-ancestors https://www.elbatt.no" always;
  proxy_hide_header X-Frame-Options;
}

# Statisk klient som /widget refererer til
location ^~ /client/ {
  proxy_http_version 1.1;
  proxy_set_header Host              $host;
  proxy_set_header X-Real-IP         $remote_addr;
  proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_pass http://127.0.0.1:8001;
}

# API-endepunkt (inkl. preflight)
location ^~ /api/ {
  if ($request_method = OPTIONS) {
    add_header Access-Control-Allow-Origin $elbatt_cors_origin always;
    add_header Access-Control-Allow-Methods "GET,POST,OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
    add_header Access-Control-Max-Age 86400 always;
    add_header Vary "Origin, Access-Control-Request-Method, Access-Control-Request-Headers" always;
    return 204;
  }
  proxy_http_version 1.1;
  proxy_set_header Host              $host;
  proxy_set_header X-Real-IP         $remote_addr;
  proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_pass http://127.0.0.1:8001;
  add_header Access-Control-Allow-Origin $elbatt_cors_origin always;
  add_header Vary Origin always;
}
