name: AI Auto Repair

on:
  workflow_run:
    workflows: ["ci-sonar", "CI/CD Pipeline"]
    types:
      - completed

jobs:
  ai_repair:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout kode
        uses: actions/checkout@v4

      - name: Hent feillogger fra siste kjÃ¸ring
        run: |
          mkdir -p .github/ai-fixes/history
          find . -name "npm-debug.log" -exec cp {} .github/ai-fixes/history/npm-debug-$(date +%s).log \; || true
          find . -name "pytest.log" -exec cp {} .github/ai-fixes/history/pytest-$(date +%s).log \; || true

      - name: Installer Python requirements
        run: pip install openai

      - name: KjÃ¸r AI-repair-script
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: python3 .github/ai-fixes/ai_code_fix.py

      - name: Lag commit og PR med forslag fra AI
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "ðŸ”§ AI-forslag: Automatisk patch etter CI-feil"
          branch: "ai-fix/auto-$(date +%Y%m%d-%H%M)"
          title: "AI-forslag: Auto-patch for CI-feil"
          body: "Denne PR-en ble generert av AI-script etter feilet pipeline. Patch ligger i .github/ai-fixes/last_patch.txt."

      - name: Send e-post om AI-forslag
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.NOTIFY_EMAIL }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "ðŸ”§ Elbatt Chatbot: Automatisk AI-forslag etter CI-feil"
          body: "AI forsÃ¸kte Ã¥ fikse repoet automatisk og har laget en PR!\n\nSe GitHub PR for detaljer."
          to: ${{ secrets.NOTIFY_EMAIL }}
