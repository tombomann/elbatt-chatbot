name: AI Autofix (Full Auto)

on:
  workflow_run:
    workflows: ["Deploy Fullstack to Scaleway Serverless"] # Navnet på din deploy/test workflow
    types:
      - completed

jobs:
  ai-autofix:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Last ned workflow-feillogg (kun siste run)
        run: |
          gh run list --workflow="${{ github.event.workflow_run.workflow_id }}" --json databaseId | jq .[0].databaseId > run_id.txt
          gh run view $(cat run_id.txt) --log > error.log || true

      - name: Lag context.txt med repo-status og CI-problemer
        run: |
          echo "
Repository summary:
- Backend: FastAPI, .env, secrets for OpenAI, Vegvesen, Langflow, m.m.
- Frontend: React, Dockerized build
- CI: deploy-all.yml bygger & deployer begge images til Scaleway, secrets fra GitHub
- Backup: backup_to_s3.py/restore_from_s3.py
- Gaps: Ikke full CI-test, SonarCloud, backup-automation, og dokumentasjon
Se full repo-status i README.md og context.txt.
---
" > context.txt
          cat error.log >> context.txt

      - name: Installer OpenAI Python SDK
        run: pip install openai

      - name: Kjør AI autofix
        run: |
          python3 <<EOF
import os
import openai

with open("context.txt") as f:
    prompt = f"""
Du er en kodeassistent som kan patche fullstack-prosjekter direkte. Feil og status:
---
{f.read()}
---
Lag en unified diff-patch som fikser feilen. Kun patch, ingen forklaring.
"""
openai.api_key = os.getenv("OPENAI_API_KEY")
resp = openai.ChatCompletion.create(
    model="gpt-4o",
    messages=[{"role": "user", "content": prompt}],
    max_tokens=2048,
    temperature=0,
)
out = resp.choices[0].message.content.strip()
print(out)
with open("codex_patch.diff", "w") as patch:
    patch.write(out)
EOF

      - name: Apply patch fra AI (full auto)
        run: |
          if [ -s codex_patch.diff ]; then
            git apply codex_patch.diff || (echo "Patch feilet"; exit 1)
            git config --global user.name "ai-autofix"
            git config --global user.email "ai-bot@elbatt.no"
            git add -A
            git commit -m "AI autofix (auto-patch via Codex/ChatGPT)"
            git push
          else
            echo "Ingen AI-patch generert."
          fi

      - name: Notify om AI-autofix feiler
        if: failure()
        run: echo "AI autofix kunne ikke reparere automatisk – sjekk context.txt og codex_patch.diff."
