name: "Auto AI-repair & PR + Merge"

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  ai-fix-and-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Sjekk ut kode
        uses: actions/checkout@v4

      - name: Sett opp Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Installer frontend dependencies
        run: |
          cd frontend
          npm ci

      - name: Kjør tester
        run: |
          cd frontend
          npm test -- --watchAll=false || true

      - name: AI-fix script (placeholder)
        run: |
          echo "Her kunne du kalle OpenAI/Deepseek/egen Python-fiks"
          # python scripts/self_heal.py
          # Kan eventuelt committe endringer hvis feil rettes

      - name: Commit endringer hvis noen filer er rettet
        run: |
          git config --global user.name "Elbatt Bot"
          git config --global user.email "bot@elbatt.no"
          git add -A || true
          git diff --cached --exit-code || git commit -m "AI-auto-fix: rettet filer automatisk"

      - name: Lag automatisk PR til main
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.PAT_TOKEN }}
          branch: ai-auto-fix
          title: "AI AutoFix: Automatisk PR"
          body: "Denne PR-en er laget automatisk etter AI-feilretting."
          delete-branch: true
          base: main

      - name: Slå på auto-merge (hvis tilgjengelig)
        if: github.event_name == 'push'
        run: |
          gh pr merge --auto --squash $(gh pr list --state open --head ai-auto-fix --json number -q '.[0].number') || true
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
