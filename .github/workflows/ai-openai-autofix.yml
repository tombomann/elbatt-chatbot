name: OpenAI Autofix Full Auto

on:
  workflow_run:
    workflows: ["CI/CD Fullstack", "ci-cd-fullstack.yml"] # Ditt hoved-workflow navn, evt. flere
    types:
      - completed

jobs:
  openai-autofix:
    if: >
      ${{ github.event.workflow_run.conclusion == 'failure' &&
           github.event.workflow_run.event == 'push' }}
    runs-on: ubuntu-latest
    steps:
      - name: Sjekk ut kode
        uses: actions/checkout@v4

      - name: Sett opp Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Installer OpenAI.
        run: |
          python -m pip install --upgrade pip
          pip install openai==0.28

      - name: Kjør OpenAI autofix-script
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python scripts/openai_autofix.py

      - name: Commit og push AI-fiks
        run: |
          git config user.name "elbattauto"
          git config user.email "bot@elbatt.no"
          git checkout -b ai-autofix/${{ github.run_id }}
          git add .
          git commit -am "AI-autofix: Rette CI/CD-feil automatisk"
          git push origin ai-autofix/${{ github.run_id }}

      - name: Opprett PR
        uses: peter-evans/create-pull-request@v6
        with:
          branch: ai-autofix/${{ github.run_id }}
          title: "AI-autofix: Automatisk rettet CI/CD-feil"
          body: |
            OpenAI har analysert feilen og foreslår kodeendringer for å fikse pipeline.
            Auto-merge aktiveres hvis PR blir grønn!
          delete-branch:
          draft: 

      # Auto-merge hvis tester er grønne
      - name: Auto-merge
        uses: "peter-evans/enable-pull-request-automerge@v3"
        with:
          pull-request-number: ${{ steps.create-pull-request.outputs.pull-request-number }}
          merge-method: squash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}