# Lag .github/workflows/deploy.yml
cat > .github/workflows/deploy.yml << 'EOF'
name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up environment
        run: |
          echo "REDIS_HOST=redis" >> .env
          echo "REDIS_PORT=6379" >> .env
          echo "REDIS_PASSWORD=" >> .env
          echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> .env
          echo "VEGVESEN_API_KEY=${{ secrets.VEGVESEN_API_KEY }}" >> .env
          echo "LANGFLOW_API_KEY=${{ secrets.LANGFLOW_API_KEY }}" >> .env
          echo "SCW_ACCESS_KEY=${{ secrets.SCW_ACCESS_KEY }}" >> .env
          echo "SCW_SECRET_KEY=${{ secrets.SCW_SECRET_KEY }}" >> .env
          echo "SCW_DEFAULT_ORGANIZATION_ID=${{ secrets.SCW_DEFAULT_ORGANIZATION_ID }}" >> .env
          echo "SCW_DEFAULT_PROJECT_ID=${{ secrets.SCW_DEFAULT_PROJECT_ID }}" >> .env
          echo "SCW_ORGANIZATION_ID=${{ secrets.SCW_ORGANIZATION_ID }}" >> .env
          echo "SCW_PROJECT_ID=${{ secrets.SCW_PROJECT_ID }}" >> .env
          echo "ALLOWED_ORIGINS=${{ secrets.ALLOWED_ORIGINS }}" >> .env
          echo "STATIC_DIR=${{ secrets.STATIC_DIR }}" >> .env
          echo "ASSETS_DIR=${{ secrets.ASSETS_DIR }}" >> .env
          echo "SENTRY_ORG=${{ secrets.SENTRY_ORG }}" >> .env
          echo "SENTRY_DSN=${{ secrets.SENTRY_DSN }}" >> .env
          echo "SONAR_TOKEN=${{ secrets.SONAR_TOKEN }}" >> .env
          echo "GH_PAT=${{ secrets.GH_PAT }}" >> .env
          echo "NETLIFY_AUTH_TOKEN=${{ secrets.NETLIFY_AUTH_TOKEN }}" >> .env
          echo "NETLIFY_SITE_ID=${{ secrets.NETLIFY_SITE_ID }}" >> .env
          
      - name: Build and deploy
        run: |
          docker-compose down
          docker-compose up --build -d
          
      - name: Health check
        run: |
          sleep 30
          curl -f http://localhost:8000/api/health || exit 1
EOF
