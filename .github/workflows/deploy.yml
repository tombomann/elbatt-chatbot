name: Deploy Backend & Frontend with Rollback, Notifications and Scan

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  SSH_HOST: ${{ secrets.SCALEAWAY_HOST }}
  SSH_USER: root
  SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
  NOTIFY_EMAIL: ${{ secrets.NOTIFY_EMAIL }}
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
  DOCKER_BACKEND_REPO: yourdockeruser/elbatt-backend
  DOCKER_FRONTEND_REPO: yourdockeruser/elbatt-frontend

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.get_tag.outputs.TAG }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Get image tag
        id: get_tag
        run: echo "TAG=$(echo $GITHUB_SHA | cut -c1-7)" >> $GITHUB_OUTPUT

      - name: Log in to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ env.DOCKER_PASSWORD }}

      - name: Build and push backend image
        working-directory: ./backend
        run: |
          docker build -t $DOCKER_BACKEND_REPO:${{ steps.get_tag.outputs.TAG }} .
          docker push $DOCKER_BACKEND_REPO:${{ steps.get_tag.outputs.TAG }}

      - name: Build and push frontend image
        working-directory: ./frontend
        run: |
          docker build -t $DOCKER_FRONTEND_REPO:${{ steps.get_tag.outputs.TAG }} .
          docker push $DOCKER_FRONTEND_REPO:${{ steps.get_tag.outputs.TAG }}

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.8.0
        with:
