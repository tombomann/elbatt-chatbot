name: Build & Deploy to Scaleway K8s

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  REGISTRY: rg.fr-par.scw.cloud/elbatt
  NS: elbatt

permissions:
  contents: read

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      TAG: ${{ steps.tag.outputs.tag }}
    steps:
      - uses: actions/checkout@v4

      - name: Compute image tag
        id: tag
        run: |
          TAG="${GITHUB_SHA::8}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Login to Scaleway Registry
        run: |
          echo "${{ secrets.SCW_REGISTRY_PASSWORD }}" | \
            docker login $REGISTRY -u "${{ secrets.SCW_REGISTRY_USERNAME }}" --password-stdin

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build & push images
        uses: docker/bake-action@v5
        with:
          push: true
          files: |
            ./docker-bake.hcl
          variables: |
            REGISTRY=${{ env.REGISTRY }}
            TAG=${{ steps.tag.outputs.tag }}

  update-manifests-and-deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    env:
      TAG: ${{ needs.build-and-push.outputs.TAG }}
    steps:
      - uses: actions/checkout@v4

      - name: Install yq (dockerized)
        run: echo "Using yq via docker image (no local install needed)"

      - name: Update image tags with yq
        run: |
          set -euo pipefail

          export REGISTRY="${{ env.REGISTRY }}"
          export TAG="${TAG}"

          yq() { docker run --rm -v "$PWD":/work -w /work mikefarah/yq:4 "$@"; }

          # admin-backend
          IMG="$REGISTRY/admin-backend:$TAG" \
          yq -i '
            .spec.template.spec.containers
            |= ( map( if .name == "admin-backend" then .image = env(IMG) else . end ) )
          ' k8s/deployment-admin-backend.yaml

          # chatbot-backend
          IMG="$REGISTRY/chatbot-backend:$TAG" \
          yq -i '
            .spec.template.spec.containers
            |= ( map( if .name == "chatbot-backend" then .image = env(IMG) else . end ) )
          ' k8s/deployment-backend.yaml

          # chatbot-frontend
          IMG="$REGISTRY/chatbot-frontend:$TAG" \
          yq -i '
            .spec.template.spec.containers
            |= ( map( if .name == "chatbot-frontend" then .image = env(IMG) else . end ) )
          ' k8s/deployment-chatbot-frontend.yaml

          # admin-frontend
          IMG="$REGISTRY/admin-frontend:$TAG" \
          yq -i '
            .spec.template.spec.containers
            |= ( map( if .name == "admin-frontend" then .image = env(IMG) else . end ) )
          ' k8s/deployment-admin-frontend.yaml

      - name: Write kubeconfig
        run: |
          echo "${{ secrets.KUBECONFIG_B64 }}" | base64 -d > kubeconfig.yaml
          chmod 600 kubeconfig.yaml

      - name: Kubectl (apply manifests)
        env:
          KUBECONFIG: ${{ github.workspace }}/kubeconfig.yaml
        run: |
          set -euo pipefail
          kubectl -n ${{ env.NS }} apply -f k8s/deployment-backend.yaml
          kubectl -n ${{ env.NS }} apply -f k8s/deployment-admin-backend.yaml
          kubectl -n ${{ env.NS }} apply -f k8s/deployment-chatbot-frontend.yaml
          kubectl -n ${{ env.NS }} apply -f k8s/deployment-admin-frontend.yaml

      - name: Wait for rollouts
        env:
          KUBECONFIG: ${{ github.workspace }}/kubeconfig.yaml
        run: |
          set -euo pipefail
          kubectl -n ${{ env.NS }} rollout status deploy/chatbot-backend --timeout=120s
          kubectl -n ${{ env.NS }} rollout status deploy/admin-backend --timeout=180s
          kubectl -n ${{ env.NS }} rollout status deploy/chatbot-frontend --timeout=120s
          kubectl -n ${{ env.NS }} rollout status deploy/admin-frontend --timeout=120s
