name: Build & Deploy to Scaleway K8s

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write   # for å committe tag-bumps når vi bygger på main

env:
  REGISTRY: rg.fr-par.scw.cloud/elbatt
  NAMESPACE: elbatt

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.meta.outputs.tag }}
    steps:
      - uses: actions/checkout@v4

      - name: Compute image tag
        id: meta
        run: |
          TAG="$(git rev-parse --short HEAD)"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "TAG=$TAG" >> $GITHUB_ENV

      - name: Login to Scaleway Container Registry
        run: |
          echo "${{ secrets.SCW_SECRET_KEY }}" \
            | docker login $REGISTRY -u "${{ secrets.SCW_ACCESS_KEY }}" --password-stdin

      # Bygger/pusher alle fire bilder (matrix)
      - name: Build & Push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ matrix.file }}
          push: true
          tags: ${{ env.REGISTRY }}/${{ matrix.name }}:${{ env.TAG }}
        strategy:
          fail-fast: false
          matrix:
            include:
              - { name: chatbot-backend,  file: backend/Dockerfile }
              - { name: admin-backend,    file: backend/Dockerfile.admin }
              - { name: chatbot-frontend, file: chatbot-frontend/Dockerfile }
              - { name: admin-frontend,   file: admin-frontend/Dockerfile }

      - name: Install yq
        run: sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.44.2/yq_linux_amd64 && sudo chmod +x /usr/local/bin/yq

      - name: Bump image tags in k8s manifests
        run: |
          export TAG="${{ steps.meta.outputs.tag }}"
          export REG="${{ env.REGISTRY }}"
          yq -i '(.spec.template.spec.containers[] | select(.name=="chatbot-backend").image)   = env(REG)+"/chatbot-backend:"+env(TAG)'   k8s/deployment-backend.yaml
          yq -i '(.spec.template.spec.containers[] | select(.name=="admin-backend").image)     = env(REG)+"/admin-backend:"+env(TAG)'     k8s/deployment-admin-backend.yaml
          yq -i '(.spec.template.spec.containers[] | select(.name=="chatbot-frontend").image)  = env(REG)+"/chatbot-frontend:"+env(TAG)'  k8s/deployment-chatbot-frontend.yaml
          yq -i '(.spec.template.spec.containers[] | select(.name=="admin-frontend").image)    = env(REG)+"/admin-frontend:"+env(TAG)'    k8s/deployment-admin-frontend.yaml

      - name: Commit manifest tag bumps (main only)
        if: ${{ github.ref == 'refs/heads/main' }}
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add k8s/deployment-*.yaml
          git commit -m "ci: bump images to tag $TAG" || echo "No changes"
          git push

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    env:
      TAG: ${{ needs.build-and-push.outputs.tag }}
    steps:
      - uses: actions/checkout@v4

      - name: Write kubeconfig from secret
        run: |
          echo '${{ secrets.KUBECONFIG_B64 }}' | base64 -d > kubeconfig-ci.yaml
          chmod 600 kubeconfig-ci.yaml
          echo "KUBECONFIG=$PWD/kubeconfig-ci.yaml" >> $GITHUB_ENV

      - name: Kubectl version
        run: kubectl version --client=true

      - name: Dry-run manifests
        run: |
          kubectl -n $NAMESPACE apply --dry-run=client -f k8s/deployment-backend.yaml
          kubectl -n $NAMESPACE apply --dry-run=client -f k8s/deployment-admin-backend.yaml
          kubectl -n $NAMESPACE apply --dry-run=client -f k8s/deployment-chatbot-frontend.yaml
          kubectl -n $NAMESPACE apply --dry-run=client -f k8s/deployment-admin-frontend.yaml
          kubectl -n $NAMESPACE apply --dry-run=client -f k8s/ingress.yaml

      - name: Apply manifests
        run: |
          set -e
          kubectl -n $NAMESPACE apply -f k8s/deployment-backend.yaml
          kubectl -n $NAMESPACE apply -f k8s/deployment-admin-backend.yaml
          kubectl -n $NAMESPACE apply -f k8s/deployment-chatbot-frontend.yaml
          kubectl -n $NAMESPACE apply -f k8s/deployment-admin-frontend.yaml
          kubectl -n $NAMESPACE apply -f k8s/ingress.yaml

      - name: Wait for rollout
        run: |
          set -e
          kubectl -n $NAMESPACE rollout status deploy/chatbot-backend    --timeout=120s
          kubectl -n $NAMESPACE rollout status deploy/admin-backend      --timeout=180s
          kubectl -n $NAMESPACE rollout status deploy/chatbot-frontend   --timeout=60s
          kubectl -n $NAMESPACE rollout status deploy/admin-frontend     --timeout=60s

      - name: In-cluster smoke test
        run: |
          set -e
          kubectl -n $NAMESPACE run smoke --rm -i --image=curlimages/curl:8.10.1 --restart=Never -- \
            sh -lc 'set -e;
              echo "chatbot-backend:";  curl -fsS http://chatbot-backend-service:8000/health;
              echo "admin-backend:";    curl -fsS http://admin-backend-service:8002/health;
              echo "chatbot-frontend:"; curl -fsSI http://chatbot-frontend-service | head -n1;
              echo "admin-frontend:";   curl -fsSI http://admin-frontend-service | head -n1;'
