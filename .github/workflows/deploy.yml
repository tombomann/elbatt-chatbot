name: Deploy Backend & Frontend with Rollback and Notifications

on:
  push:
    branches:
      - main

env:
  SSH_HOST: ${{ secrets.SCALEAWAY_HOST }}
  SSH_USER: root
  SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
  NOTIFY_EMAIL: ${{ secrets.NOTIFY_EMAIL }}
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
  DOCKER_BACKEND_REPO: yourdockeruser/elbatt-backend
  DOCKER_FRONTEND_REPO: yourdockeruser/elbatt-frontend

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.get_tag.outputs.TAG }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Get image tag
        id: get_tag
        run: echo "TAG=$(echo $GITHUB_SHA | cut -c1-7)" >> $GITHUB_OUTPUT

      - name: Log in to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ env.DOCKER_PASSWORD }}

      - name: Build and push backend image
        working-directory: ./backend
        run: |
          docker build -t $DOCKER_BACKEND_REPO:${{ steps.get_tag.outputs.TAG }} .
          docker push $DOCKER_BACKEND_REPO:${{ steps.get_tag.outputs.TAG }}

      - name: Build and push frontend image
        working-directory: ./frontend
        run: |
          docker build -t $DOCKER_FRONTEND_REPO:${{ steps.get_tag.outputs.TAG }} .
          docker push $DOCKER_FRONTEND_REPO:${{ steps.get_tag.outputs.TAG }}

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.8.1
        with:
          ssh-private-key: ${{ env.SSH_KEY }}

      - name: Deploy to Scaleaway via SSH
        id: deploy_step
        run: |
          set -e
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST << EOF
            cd /root/elbatt-chatbot
            echo "Oppdaterer miljÃ¸variabel for docker tags"
            # Eksempel: skriv tag til .env eller oppdater docker-compose.yml med riktig tag
            echo "BACKEND_IMAGE_TAG=${{ needs.build-and-push.outputs.image_tag }}" > .env
            echo "FRONTEND_IMAGE_TAG=${{ needs.build-and-push.outputs.image_tag }}" >> .env

            docker-compose pull
            docker-compose up -d --remove-orphans --build
          EOF

  rollback:
    if: failure()
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.8.1
        with:
          ssh-private-key: ${{ env.SSH_KEY }}

      - name: Rollback deploy on failure
        run: |
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST << EOF
            set -e
            cd /root/elbatt-chatbot
            echo "Rollback: Bytter til forrige docker image tag"
            # Oppdater denne variabelen manuelt eller via en strategi for forrige tag
            echo "BACKEND_IMAGE_TAG=previous_tag" > .env
            echo "FRONTEND_IMAGE_TAG=previous_tag" >> .env
            docker-compose pull
            docker-compose up -d --remove-orphans --build
          EOF

  notify:
    needs: [deploy, rollback]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Send notification email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: ${{ job.status == 'success' && '[Elbatt] Deploy OK' || '[Elbatt] Deploy FAILED' }}
          to: ${{ env.NOTIFY_EMAIL }}
          from: Elbatt Chatbot <${{ secrets.SMTP_USERNAME }}>
          body: |
            Deploy status: ${{ job.status }}
            Commit: ${{ github.sha }}
            Ref: ${{ github.ref }}
            Workflow: ${{ github.workflow }}
