name: Deploy Backend & Frontend with Tests, SonarQube, Rollback, Notifications & Scan

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  SSH_HOST: ${{ secrets.SCALEAWAY_HOST }}
  SSH_USER: root
  SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
  NOTIFY_EMAIL: ${{ secrets.NOTIFY_EMAIL }}
  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
  SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.get_tag.outputs.TAG }}
    steps:
      - uses: actions/checkout@v3
      - name: Get image tag
        id: get_tag
        run: echo "TAG=$(echo $GITHUB_SHA | cut -c1-7)" >> $GITHUB_OUTPUT

  test-frontend:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '20'
      - name: Install dependencies
        working-directory: ./frontend
        run: npm install
      - name: Run frontend tests
        working-directory: ./frontend
        run: npm run test -- --watchAll=false --coverage

  test-backend:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Install backend dependencies
        working-directory: ./backend
        run: |
          pip install -r requirements.txt
          pip install pytest
      - name: Run backend tests
        working-directory: ./backend
        run: pytest

  sonarcloud:
    runs-on: ubuntu-latest
    needs: [test-frontend, test-backend]
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ env.SONAR_TOKEN }}

  deploy:
    needs: sonarcloud
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ env.SSH_KEY }}
      - name: Deploy to Scaleaway
        run: |
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST << EOF
            cd /root/elbatt-chatbot
            git pull origin main
            docker-compose down
            docker-compose build
            docker-compose up -d --remove-orphans
          EOF

  rollback:
    if: failure()
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ env.SSH_KEY }}
      - name: Rollback deploy
        run: |
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST << EOF
            cd /root/elbatt-chatbot
            git reset --hard HEAD~1
            docker-compose down
            docker-compose build
            docker-compose up -d --remove-orphans
          EOF

  notify:
    needs: [deploy, rollback]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: ${{ job.status == 'success' && '[Elbatt] Deploy OK' || '[Elbatt] Deploy FAILED' }}
          to: ${{ env.NOTIFY_EMAIL }}
          from: Elbatt Chatbot <${{ secrets.SMTP_USERNAME }}>
          body: |
            Deploy status: ${{ job.status }}
            Commit: ${{ github.sha }}
            Workflow: ${{ github.workflow }}

  scan-scaleaway:
    needs: [deploy, rollback, notify]
    runs-on: ubuntu-latest
    steps:
      - uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          key: ${{ env.SSH_KEY }}
          script: |
            cd /root/elbatt-chatbot
            find . -type f > file-list.txt
            du -h --max-depth=3 > disk-usage.txt
      - uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          key: ${{ env.SSH_KEY }}
          source: "/root/elbatt-chatbot/file-list.txt,/root/elbatt-chatbot/disk-usage.txt"
          target: "."
      - uses: actions/upload-artifact@v3
        with:
          name: scaleaway-scan
          path: |
            file-list.txt
            disk-usage.txt
