name: Deploy Backend & Frontend Direct to Scaleaway with Rollback, Notifications and Scan

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  SSH_HOST: ${{ secrets.SCALEAWAY_HOST }}
  SSH_USER: root
  SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
  NOTIFY_EMAIL: ${{ secrets.NOTIFY_EMAIL }}

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.get_tag.outputs.TAG }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Get image tag
        id: get_tag
        run: echo "TAG=$(echo $GITHUB_SHA | cut -c1-7)" >> $GITHUB_OUTPUT

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ env.SSH_KEY }}

      - name: Deploy and build on Scaleaway
        id: deploy_step
        run: |
          set -e
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST << EOF
            cd /root/elbatt-chatbot
            git pull origin main
            echo "BACKEND_IMAGE_TAG=${{ needs.build.outputs.image_tag }}" > .env
            echo "FRONTEND_IMAGE_TAG=${{ needs.build.outputs.image_tag }}" >> .env
            docker-compose down
            docker-compose build
            docker-compose up -d --remove-orphans
          EOF

  rollback:
    if: failure()
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ env.SSH_KEY }}

      - name: Rollback deploy on failure
        run: |
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST << EOF
            set -e
            cd /root/elbatt-chatbot
            echo "Rollback: Starter gamle images (forrige git commit)"
            git reset --hard HEAD~1
            docker-compose down
            docker-compose build
            docker-compose up -d --remove-orphans
          EOF

  notify:
    needs: [deploy, rollback]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Send notification email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: ${{ job.status == 'success' && '[Elbatt] Deploy OK' || '[Elbatt] Deploy FAILED' }}
          to: ${{ env.NOTIFY_EMAIL }}
          from: Elbatt Chatbot <${{ secrets.SMTP_USERNAME }}>
          body: |
            Deploy status: ${{ job.status }}
            Commit: ${{ github.sha }}
            Ref: ${{ github.ref }}
            Workflow: ${{ github.workflow }}

  scan-scaleaway:
    needs: [deploy, rollback, notify]
    runs-on: ubuntu-latest
    steps:
      - name: Scan files and disk usage on Scaleaway
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          key: ${{ env.SSH_KEY }}
          script: |
            cd /root/elbatt-chatbot
            find . -type f > file-list.txt
            du -h --max-depth=3 > disk-usage.txt

      - name: Download file list and disk usage from Scaleaway
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          key: ${{ env.SSH_KEY }}
          source: "/root/elbatt-chatbot/file-list.txt,/root/elbatt-chatbot/disk-usage.txt"
          target: "."

      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: scaleaway-scan
          path: |
            file-list.txt
            disk-usage.txt
